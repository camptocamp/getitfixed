{% extends 'c2cgeoform:/templates/grid.jinja2' %}
{% block calculateTableHeightJS %}
return $(window).height() - $('footer').height() - $('header').height() - 30
{% endblock %}
{% block grid %}
    {{ super() }}
<script>
  $(function() {
     const bsTable = $('#grid')
     let dataUrl = bsTable.data()['bootstrap.table'].options.url
     let openIssues = '{{request.localizer.translate("Get open")}}'
     let allIssues = '{{request.localizer.translate("Get all")}}'
     const url  = new URL(dataUrl)

     let buttonElement = $('<button/>', {class: 'btn btn-default'})
          .append($(`<span class="toggle-visible-issues">${openIssues}</span>`).data('issues', 'open'))
          .append($(`<span>${allIssues}</span>`).data('issues', 'all'))

     let fetchIssues = function(key, value) {
          url.searchParams.set(key, value)
          bsTable.data()['bootstrap.table'].options.url = url.toString()
          bsTable.bootstrapTable('refresh')
     }

     let getIssuesByStatus = function () {
         let span = buttonElement.find("span")
         span.toggleClass("toggle-visible-issues")
         let status = span.data().issues
         fetchIssues('all', status === 'all' ? 'false' : 'true')
     }

     let getIssuesByCategory = function (e) {
         dropDownElement.text(e.currentTarget.textContent)
         fetchIssues('category', e.currentTarget.value)
     }

    const buttonGroup = $('.list-grid .btn-group.pull-right')
    buttonElement.click(getIssuesByStatus)
    buttonGroup.append(buttonElement)

    // category filter
    const categories = {{ categories|tojson|safe }}
    let dropDownElement = $('<button/>', {class: 'btn btn-default dropdown-toggle',
          'data-toggle': 'dropdown'})
          .text('{{ _('All Categories') }}')
          .append($('<span/>', {class: 'caret'}))
    // add dropDown to button group
    buttonGroup.append(dropDownElement)
    // dropDown content
    let dropDownMenu = $('<ul/>', {class: 'dropdown-menu'})

    buttonGroup.append(dropDownMenu)
    // add extra li for all categories
    categories.splice(0,0, {id: '0', value: '{{ _('All Categories') }}'})
    for (let cat of categories) {
          dropDownMenu.append($('<li/>', {value: cat.id})
            .append($('<a/>').text(cat.value))
              .click(getIssuesByCategory)
          )
    }
  })
</script>
{% endblock %}
