{% extends 'c2cgeoform:/templates/grid.jinja2' %}
{% block calculateTableHeightJS %}
return $(window).height() - $('footer').height() - $('header').height() - 30
{% endblock %}
<script>
  $(function() {
     const bsTable = $('#grid')
     let dataUrl = bsTable.data()['bootstrap.table'].options.url
     let openIssues = '{{request.localizer.translate("Get open")}}'
     let allIssues = '{{request.localizer.translate("Get all")}}'
     const url  = new URL(dataUrl)

     let buttonElement = $('<button/>', {class: 'btn btn-default'})
          .append($(`<span class="hidden">${openIssues}</span>`).data('issues', 'open'))
          .append($(`<span>${allIssues}</span>`).data('issues', 'all'))

     let fetchIssues = function(key, value) {
          url.searchParams.set(key, value)
          bsTable.data()['bootstrap.table'].options.url = url.toString()
          bsTable.bootstrapTable('refresh')
     }

     let getIssuesByStatus = function () {
         let spans = buttonElement.find('span')
         spans.toggleClass("hidden")
         let status = spans.not('.hidden').data().issues
         fetchIssues('all', status === 'all' ? 'false' : 'true')
     }

     let getIssuesByCategory = function (e) {
         $(dropDownElement.find('.category-label')).text(e.currentTarget.textContent)
         fetchIssues('category', $(e.currentTarget).data().categoryId)
     }

    const buttonGroup = $('.list-grid .btn-group.pull-right')
    buttonElement.click(getIssuesByStatus)
    buttonGroup.append(buttonElement)

    // category filter
    const categories = {{ categories|tojson|safe }}
    let dropDownElement = $('<button/>', {class: 'btn btn-default dropdown-toggle',
          'data-toggle': 'dropdown'})
          .append($('<span/>', {class: 'category-label'}).text('{{ _('All Categories') }}'))
          .append($('<span/>', {class: 'caret'}))
    // add dropDown to button group
    buttonGroup.append(dropDownElement)
    // dropDown content
    let dropDownMenu = $('<ul/>', {class: 'dropdown-menu'})

    buttonGroup.append(dropDownMenu)
    // add extra li for all categories
    categories.splice(0,0, {id: '0', value: '{{ _('All Categories') }}'})
    for (let cat of categories) {
        dropDownMenu.append($('<li/>')
            .append($('<a/>', {href: '#'}).text(cat.value).data('categoryId', cat.id)
                .click(getIssuesByCategory)
            )
        )
    }
  })
</script>
{# see: https://github.com/wenzhixin/bootstrap-table/tree/develop/src/locale #}
{% set bootstrap_table_locales = {
    'de': 'de-DE',
    'en': 'en-US',
    'fr': 'fr-FR',
} %}
<div class="list-grid">

    <table class="table table-condensed table-hover table-striped issue-grid">
        <thead>
        <tr>
            {% for field in list_fields %}
                <th data-field="{{field.id()}}"
                    data-sortable="{{'true' if field.sortable() else 'false'}}"
                    data-visible="{{'true' if field.visible() else 'false'}}"
                    class="{{field.id()}}"
                >{{request.localizer.translate(field.label())}}</th>
            {% endfor %}
        </tr>
        </thead>
    </table>

    <script>
        $('.issue-grid').bootstrapTable({
            url: "{{request.route_url('c2cgeoform_grid')}}",
            search: true,
            pagination: true,
            sidePagination: 'server',
            pageSize: 20,
            pageList: [20],
            locale: '{{ bootstrap_table_locales[request.locale_name] }}',
            uniqueId: '_id_',
        })
    </script>
</div>
